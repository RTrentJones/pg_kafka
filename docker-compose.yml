version: '3.8'

services:
  pg_kafka_dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: pg_kafka_dev
    volumes:
      # Mount your current directory (code) into the container
      - .:/home/postgres/workspace

      # Persist the Cargo cache so re-builds are fast
      - cargo_cache:/home/postgres/.cargo/registry
      - target_cache:/home/postgres/workspace/target
    ports:
      - "5432:5432"  # Access Postgres from host
      - "9092:9092"  # Access Kafka Protocol from host
    environment:
      - RUST_LOG=info
      # Shadow mode configuration for testing (Phase 11)
      # Using PLAINTEXT for dev simplicity - add SASL when needed
      - PG_KAFKA_SHADOW_BOOTSTRAP_SERVERS=external-kafka:9093
      - PG_KAFKA_SHADOW_SECURITY_PROTOCOL=PLAINTEXT
    # Security tweak to allow gdb/perf if you need to debug crashes
    privileged: true
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    # depends_on:  # Uncomment when external-kafka is fixed
    #   external-kafka:
    #     condition: service_healthy
    networks:
      - pg_kafka_network

  # External Kafka for shadow mode testing (Phase 11)
  # Uses KRaft mode (no ZooKeeper) with PLAINTEXT for simplicity
  # TODO: Add SASL/PLAIN auth when needed for production-like testing
  external-kafka:
    image: apache/kafka:3.7.0
    container_name: external_kafka
    hostname: external-kafka
    ports:
      - "9093:9093"    # External Kafka listener
    environment:
      # KRaft mode configuration (no ZooKeeper)
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@external-kafka:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Listeners configuration (PLAINTEXT - no auth for dev simplicity)
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9093,CONTROLLER://0.0.0.0:9094
      # Use localhost for advertised listeners so host-based CI tests can connect
      # Note: For container-to-container communication (e.g., pg_kafka_dev -> external-kafka),
      # you would need to use a dual-listener setup or host network mode
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Storage configuration
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk

      # Topic defaults
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9093 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - pg_kafka_network

networks:
  pg_kafka_network:
    driver: bridge

volumes:
  cargo_cache:
  target_cache:
  kafka_data:
