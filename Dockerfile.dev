FROM rust:1.81-bookworm

# 1. Install System Dependencies required by pgrx and Kafka protocols
RUN apt-get update && apt-get install -y \
    clang \
    gcc \
    libssl-dev \
    pkg-config \
    libreadline-dev \
    zlib1g-dev \
    flex \
    bison \
    sudo \
    wget \
    && rm -rf /var/lib/apt/lists/*

# 1.5. Install kcat (formerly kafkacat) for Kafka protocol testing
# Download and install from GitHub releases
RUN wget -q https://github.com/edenhill/kcat/releases/download/1.7.1/kcat_1.7.1-1_amd64.deb \
    && sudo dpkg -i kcat_1.7.1-1_amd64.deb \
    && rm kcat_1.7.1-1_amd64.deb

# 2. Create a non-root user 'postgres'
# Postgres refuses to run as root, so we must build and run as this user.
ARG USER=postgres
ARG UID=1000
ARG GID=1000

RUN groupadd -g $GID $USER \
    && useradd -m -u $UID -g $GID -s /bin/bash $USER \
    && echo "$USER ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers

# 3. Switch to non-root user
USER $USER
WORKDIR /home/$USER/workspace

# 4. Install cargo-pgrx
# We use --locked to ensure stability.
RUN cargo install --locked cargo-pgrx --version 0.16.1

# 5. Initialize pgrx
# This downloads/compiles the Postgres versions pgrx needs.
# This step takes time, so we do it in the build to cache it.
RUN cargo pgrx init --pg14 download

# 6. Expose ports
# 5432 = Postgres
# 9092 = Your Kafka Extension
EXPOSE 5432 9092

# 7. Default Command: Keep container alive
CMD ["sleep", "infinity"]